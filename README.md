# 一条工務店 間取り図 → Blender 3Dモデル 自動変換ツール

このツールは、一条工務店の2D間取り図（PDF/JPG/PNG）から壁と床を検出し、Blender用の3D座標データを自動生成します。

## 🎯 主な機能

- **複数フォーマット対応**: PDF、JPEG、PNG形式の間取り図に対応
- **完全自動パイプライン**: 1コマンドでPDF読み込みからBlenderスクリプト生成まで実行
- **高精度壁検出**: PyMuPDFとOpenCVによる太い黒線抽出
- **ノイズ除去**: 小さな点、ロゴ、記号などを自動除去
- **3D座標生成**: Blender用のJSON形式で壁の3D座標データを出力
- **可視化ツール**: 検出結果を2Dで視覚的に確認可能

## 📋 必要な環境

- Python 3.11+
- 仮想環境（推奨）

### インストール済みパッケージ
```
PyMuPDF (fitz)
OpenCV (cv2)
NumPy
scikit-image
```

## 🚀 使い方

### Streamlit（GUI）で実行する

ブラウザUIでPDFを読み込み、ワンクリックでBlender用スクリプトまで生成できます。

```bash
# 依存関係のインストール（仮想環境推奨）
pip install -r requirements.txt

# Streamlitアプリの起動
streamlit run streamlit_app.py
```

手順:
- 画面でPDF/JPG/PNGをアップロード
- 必要ならパラメータ（閾値/線幅/スケール等）を調整
- [変換を実行] を押す → JSON・Blenderスクリプト・可視化PNGをダウンロード可能

一括ダウンロード:
- 生成後に「JSON+Blenderスクリプト+抽出PNGを一括（ZIP）」ボタンで、複数ファイルをまとめて取得できます。
- 個別にも「JSON」「Blenderスクリプト」「**3DビューアHTML★**」「壁線抽出PNG」「可視化PNG」をそれぞれダウンロード可能です。

#### ★ 3DビューアHTML（Blender不要！）

**使い方（超簡単）**:
1. ZIPを解凍または「3DビューアHTML」をダウンロード
2. `viewer_3d.html` をダブルクリック → **ブラウザで自動表示**！
   - **注意**: JSONファイルは不要です（HTML内に埋め込み済み）

**特徴**:
- ✔️ **Blender不要** / Python不要 / インストール不要
- ✔️ マウスで**回転・拡大縮小・移動**できるインタラクティブ表示
- ✔️ スマホ・タブレットでも表示可能（営業プレゼンに最適）
- ✔️ Three.js（CDN）を使用した完全ローカル動作
- ✔️ **1ファイル完結**（JSONデータ内蔵）

補足:
- このUIではOpenCVの手動ROI選択は未対応です。必要な場合は、あらかじめ画像をトリミングしてからアップロードしてください。

### 1. 基本的な使い方（推奨）

**方法A: ROI手動選択（推奨！）** ⭐

引数なしで実行すると、ファイル選択ダイアログとROI選択が使えます。

```bash
python pipeline_to_blender.py
```

1. ファイル選択ダイアログで間取り図を選択
2. 処理オプションで「1. ROI手動選択」を選択（推奨）
3. 表示された画像で間取り図の範囲をマウスでドラッグ
4. スペースキーまたはEnterで確定
5. 自動処理開始！

**メリット:**
- ロゴ、記号、注釈などを確実に除外
- 処理したい範囲だけを正確に指定
- 壁が消える心配なし

**方法B: コマンドラインで指定**

```bash
# ROI選択モード（推奨）
python pipeline_to_blender.py data/test11.pdf --roi

# 自動処理（ロゴも検出される可能性あり）
python pipeline_to_blender.py data/test11.pdf

このコマンドで以下が自動実行されます:
1. PDF/画像の読み込み
2. 壁線の抽出とノイズ除去
3. 3D座標データ生成
4. 可視化画像の作成


### 2. 個別スクリプトでの実行（詳細制御が必要な場合）

#### ステップ1: PDF → 画像変換
```bash
python pdf_to_image.py input.pdf 0 output.png
```

#### ステップ2: 画像 → 壁線抽出
```bash
# PDFから
python refine_thick_lines.py input.pdf 180 12

# 画像から
python refine_from_image.py input.png 180 12
```

パラメータ:
- `180`: 黒線判定の閾値（0-255、低いほど黒線として検出しやすい）
- `12`: 最小線幅（ピクセル）

#### ステップ3: 壁線 → 3D座標データ
```bash
python extract_walls_to_3d_v2.py refined_t180_w12.png walls_3d.json 2.4 0.01
```

パラメータ:
- `refined_t180_w12.png`: 壁線抽出済み画像
- `walls_3d.json`: 出力JSONファイル
- `2.4`: 壁の高さ（メートル）
- `0.01`: スケール（ピクセル→メートル変換係数）

#### ステップ4: 可視化
```bash
python visualize_3d_walls.py walls_3d.json output.png 50
```

## 📁 出力ファイル

`pipeline_to_blender.py`またはStreamlitを実行すると、以下のファイルが生成されます：

```
プレフィックス_source.png           # 元画像
プレフィックス_refined.png          # 壁線抽出結果
プレフィックス_3d.json              # 3D座標データ
プレフィックス_visualization.png   # 2D可視化
プレフィックス_blender_import.py   # Blenderインポートスクリプト
viewer_3d.html                      # 3DビューアHTML ★NEW
```

## 🎨 Blenderでの使い方

1. Blenderを起動
2. **Scripting** タブを開く
3. 生成された `*_blender_import.py` を開く
4. **Alt+P** または **Run Script** ボタンで実行

壁が3Dオブジェクトとして生成されます！

### Blenderでのスケール調整

生成されたJSONファイルのデフォルト値:
- **厚さ (Y軸)**: 0.22m
- **高さ (Z軸)**: 5.22m

スケールを変更したい場合は、`extract_walls_to_3d_v2.py` の191-198行目付近を編集して再実行してください。

## 🔧 パラメータチューニング

### 壁線抽出の調整

黒線がうまく検出されない場合、閾値や太さを調整できます。

### 3D変換の調整

`extract_walls_to_3d_v2.py`のパラメータ:

- **maxLineGap**: 壁の隙間を埋める最大距離（大きいほど隙間を埋める）
- **minLineLength**: 検出する最小線の長さ（小さいほど短い壁も検出）
- **threshold**: Hough変換の閾値（低いほど多くの線を検出）

## 📊 処理例

### 入力
- `data/test1.pdf` (一条工務店の間取り図PDF)

### 出力
```
demo_source.png            # 4963×3509ピクセル
demo_refined.png           # 2297×1544ピクセル（壁線のみ）
demo_3d.json               # 25個の壁セグメント、総延長85.39m
demo_visualization.png     # 2D可視化
demo_blender_import.py     # Blenderスクリプト
```

## ⚠️ 既知の制限事項

1. **窓・階段情報の喪失**: 現在のバージョンでは黒線（壁）のみを検出するため、窓や階段の情報は含まれません
2. **L字コーナーの隙間**: 一部のL字型コーナーで壁が完全につながらない場合があります（v2最適化で大幅改善済み）
3. **手描き間取り図**: 線が太すぎる/薄すぎる、または不均一な場合は検出精度が低下します

## 🛠️ トラブルシューティング

### エラー: `ファイルが見つかりません`
- ファイルパスが正しいか確認
- 相対パスまたは絶対パスを使用

### 壁が検出されない
- 黒線閾値を上げる（例: 180 → 200）
- 最小太さを減らす（例: 12 → 8）

### 壁が多すぎる（ノイズが多い）
- 黒線閾値を下げる（例: 180 → 160）
- 最小太さを増やす（例: 12 → 15）

### Blenderで壁が表示されない
- JSONファイルのパスが正しいか確認
- Blenderのコンソールでエラーメッセージを確認

## 📝 ファイル構成

```
Ichijo_v2/
├── pipeline_to_blender.py          # 統合パイプライン（メイン）★
├── pdf_to_image.py                 # PDF → 画像変換
├── refine_thick_lines.py           # 壁線抽出（PDFから）
├── refine_from_image.py            # 壁線抽出（画像から）
├── extract_walls_to_3d_v2.py       # 3D座標生成（推奨版）★
├── visualize_3d_walls.py           # 2D可視化
├── blender_import_walls.py         # Blenderインポート（テンプレート）
├── data/
│   └── test1.pdf                   # サンプル間取り図
└── README.md                       # このファイル
```

## 🎓 開発者向け情報

### アルゴリズム概要

1. **PDF/画像読み込み**: PyMuPDFで300DPIに変換
2. **太線抽出**: 距離変換で線の太さを計算し、閾値以上の部分を抽出
3. **ノイズ除去**: 
   - 小さな連結成分除去（面積 < 100px）
   - 孤立図形除去（円形度 > 0.3）
   - メイン領域抽出（最大連結成分）
4. **骨格化**: Zhang-Suen法で中心線を抽出
5. **直線検出**: Hough変換で壁セグメントを検出
6. **線の統合**: 
   - 距離閾値30px、角度閾値15°で近い線を結合
   - 3回の反復マージでL字コーナーを接続
7. **3D変換**: ピクセル座標をメートル単位に変換

### バージョン比較

- **v1**: 初期版（29壁、80.04m）- 隙間多い
- **v2**: 推奨版（25壁、85.39m）- バランス最良 ✅
- **v3**: L字強化版（26壁、75.82m）- 過剰統合
- **v4**: 保守的版（23壁、72.70m）- 統合不足

---

**作成日**: 2025年12月11日  
**最終更新**: 2025年12月11日
   - 二値化
   - モルフォロジー処理

2. **壁の検出**
   - 輪郭検出
   - アスペクト比によるフィルタリング（細長い矩形を壁と判定）

3. **床の検出**
   - 壁を除いた領域を部屋として検出

4. **座標変換**
   - 画像座標系からBlender座標系に変換
   - 原点を図面の左下に設定

## 注意事項

- 間取り図は明瞭で、壁が黒い線で描かれている必要があります
- スケール係数は自動推定されますが、より正確な変換のために手動で設定することを推奨します
- 検出精度は間取り図の品質に依存します
